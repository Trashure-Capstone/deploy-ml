<!DOCTYPE html>
<html>
  <head>
    <title>Prediksi</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <style>
      .btn-outline-primary {
        border-color: #009879; /* Warna border hijau sesuai gambar */
        color: #009879; /* Warna teks hijau sesuai gambar */
      }

      .btn-outline-primary:hover {
        background-color: #009879; /* Warna latar belakang hijau saat dihover */
        color: white; /* Warna teks putih saat dihover */
      }
    </style>
  </head>
  <body style="background-color: #bfbfbf">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="title-box" style="background-color: #009879">
          <h4 style="color: #f8f9fa; margin: 10px">Plastic Waste Classification</h4>
        </div>
        <div>
          <a class="btn btn-outline-primary" style="background-color: #009879; color: #ffffff;" href="/">Prediksi</a>
          <a href="{{ url_for('monitoring') }}" class="btn btn-outline-primary">Monitoring</a>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card drop-area-card shadow">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
              <div
                id="drop-area"
                class="border rounded"
                style="height: 350px; width: 100%; cursor: pointer; position: relative"
              >
                <div class="text-center" id="drop-text">
                  <p class="mt-3">Drag and drop or click to replace</p>
                </div>
                <input type="file" id="fileElem" multiple accept="image/*" class="d-none" />
                <div id="preview-container" class="preview-container">
                  <img id="image-preview" class="img-fluid" src="" alt="Image Preview" />
                  <button id="remove-button" class="btn btn-danger remove-button">
                    <i class="bi bi-x"></i> Remove
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card rounded result-area-card shadow">
            <div class="card-body result-area" style="background-color: #ffffff">
              <h5 class="card-title text-left">Result</h5>
              <div class="result-content d-flex flex-column align-items-left">
                <p class="card-text">Confidence: <span id="confidence"></span></p>
                <p class="card-text">Processing time: <span id="processingTime"></span></p>
                <p class="card-text">Identification: <span id="identification"></span></p>
                <div class="d-flex justify-content-around icon-container mt-3">
                  <img
                    src="../static/Trashure.svg"
                    class="img-thumbnail result-icon"
                    id="trashureIcon"
                  />
                  <img
                    src="../static/Avalanche.svg"
                    class="img-thumbnail result-icon"
                    id="avalancheIcon"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4 shadow">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between title" style="background-color: #009879">
            <h4 style="color: #f8f9fa; margin: 5px">Prediction History</h4>
          </div>
          <table class="table mt-4 table-striped table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>Icon</th>
                <th>Identification</th>
                <th>Confidence</th>
                <th>Processing Time</th>
                <th>Date Time</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="predictionHistory">
              <tr>
                {% for item in history %}
                <td>{{ loop.index + (page - 1) * per_page }}</td>
                <td>
                  {% if app.config['ENV'] == 'development' %}
                  <img
                    src="{{ url_for('static', filename=item.path) }}"
                    alt="icon"
                    class="img-thumbnail"
                  />
                  {% else %}
                  <img src="{{ item.path }}" alt="icon" class="img-thumbnail" />
                  {% endif %}
                </td>
                <td>
                  {{ item.identification }} {% if item.is_correct == 0 %}
                  <span class="badge bg-danger">Miss</span>
                  {% endif %}
                </td>
                <td>{{ item.confidence }}</td>
                <td>{{ item.processing_times }}</td>
                <td>{{ item.created_at }}</td>
                <td>
                  <button
                    type="button"
                    class="btn btn-primary btn-sm review-button"
                    data-bs-toggle="modal"
                    data-bs-target="#reviewModal"
                    data-bs-id="{{ item.id }}"
                    data-bs-image="{{ item.path }}"
                    data-bs-identification="{{ item.identification }}"
                    data-bs-dismiss="{{ item.is_correct }}"
                    data-bs-newIdentification="{{ item.new_identification }}"
                    data-bs-confidence="{{ item.confidence }}"
                    data-bs-processing-time="{{ item.processing_times }}"
                    data-bs-date-time="{{ item.created_at }}"
                  >
                    Review
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div
            class="modal fade"
            id="reviewModal"
            tabindex="-1"
            aria-labelledby="reviewModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="reviewModalLabel">Riwayat Detail</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <img id="modalImage" src="" alt="Image Preview" class="img-fluid" />
                    </div>
                    <div class="col-md-6">
                      <table class="table table-bordered">
                        <thead>
                          <th>Identification</th>
                          <th>Confidence</th>
                          <th>Processing Time</th>
                          <th>Date Time</th>
                        </thead>
                        <tbody>
                          <tr>
                            <td id="modalIdentification"></td>
                            <td id="modalConfidence"></td>
                            <td id="modalProcessingTime"></td>
                            <td id="modalDateTime"></td>
                          </tr>
                        </tbody>
                      </table>
                      <div class="input-group mb-3">
                        <span class="input-group-text">Identification Correction</span>
                        <select class="form-control" id="modalIdentificationCorrection">
                          <option value="">Plastic Type...</option>
                          <option value="PET">PET</option>
                          <option value="HDPE">HDPE</option>
                          <option value="LDPE">LDPE</option>
                          <option value="PP">PP</option>
                          <option value="PS">PS</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                    Reviewed
                  </button>
                  <button type="button" class="btn btn-danger" id="deleteButton">Delete</button>
                  <button type="button" class="btn btn-primary" id="updateButton">Update</button>
                </div>
              </div>
            </div>
          </div>
          <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
              {% if page > 1 %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <a
                  class="page-link"
                  href="#"
                  tabindex="-1"
                  aria-disabled="true"
                  aria-label="Previous"
                >
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% endif %} {% for p in range(1, total_pages + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}">{{ p }}</a>
              </li>
              {% endfor %} {% if page < total_pages %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let dropArea = document.getElementById('drop-area');
    let fileElem = document.getElementById('fileElem');
    let gallery = document.getElementById('drop-text');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach((eventName) => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach((eventName) => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    dropArea.addEventListener('drop', handleDrop, false);

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function highlight(e) {
      dropArea.classList.add('highlight');
    }

    function unhighlight(e) {
      dropArea.classList.remove('highlight');
    }

    function handleDrop(e) {
      let dt = e.dataTransfer;
      let files = dt.files;
      dropText.style.display = 'none';
      handleFiles(files);
    }

    dropArea.addEventListener('click', () => {
      fileElem.click();
    });

    fileElem.addEventListener('change', function (e) {
      handleFiles(this.files);
    });

    function handleFiles(files) {
      files = [...files];
      files.forEach(previewFile);
    }

    function previewFile(file) {
      let reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onloadend = function () {
        let img = document.getElementById('image-preview');
        img.onload = function () {
          // Tunggu sampai gambar selesai dimuat
          document.getElementById('preview-container').style.display = 'block'; // Tampilkan pratinjau
          document.getElementById('drop-text').style.display = 'none'; // Sembunyikan teks
          document.getElementById('remove-button').style.display = 'block'; // Tampilkan tombol hapus
        };
        img.src = reader.result;
      };
    }

    // Event listener untuk tombol hapus
    document.getElementById('remove-button').addEventListener('click', function () {
      document.getElementById('image-preview').src = '';
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('drop-text').style.display = 'block';
      document.getElementById('remove-button').style.display = 'none';
    });

    // Fungsi mengirim ke API
    document.getElementById('fileElem').addEventListener('change', function (e) {
      const file = e.target.files[0];

      if (file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/scan', {
          method: 'POST',
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            const confidence = data.result.confidence;
            const processingTime = data.result.processingTime + ' ms';
            const identification = data.result.identification;

            document.getElementById('confidence').textContent = confidence;
            document.getElementById('processingTime').textContent = processingTime;
            document.getElementById('identification').textContent = identification;
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }
    });

    function addEmptyRowsToTable() {
      const tableBody = document.getElementById('predictionHistory');
      const currentRows = tableBody.rows.length; // Jumlah baris saat ini

      for (let i = currentRows; i < 10; i++) {
        // Tambahkan baris hingga mencapai 10
        const newRow = tableBody.insertRow();
        for (let j = 0; j < 7; j++) {
          // 7 kolom pada tabel Anda
          const cell = newRow.insertCell();
          cell.textContent = '  '; // Isi sel dengan tanda '-' atau biarkan kosong
        }
      }
    }
    addEmptyRowsToTable();

    // Modal review Function
    const reviewModal = document.getElementById('reviewModal');
    reviewModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;

      const id = button.getAttribute('data-bs-id');
      //   const isCorrect = button.getAttribute('data-bs-dismiss');
      //   const newIdentification = button.getAttribute('data-bs-newIdentification');
      const imagePath = button.getAttribute('data-bs-image');
      const identification = button.getAttribute('data-bs-identification');
      const confidence = button.getAttribute('data-bs-confidence');
      const processingTime = button.getAttribute('data-bs-processing-time');
      const dateTime = button.getAttribute('data-bs-date-time');

      // Update the modal's content
      const modalImage = reviewModal.querySelector('#modalImage');
      //   const modalCorrection = reviewModal.querySelector('#modalCorrection');
      //   const modalIdentificationCorrection = reviewModal.querySelector(
      //     '#modalIdentificationCorrection'
      //   );
      const modalIdentification = reviewModal.querySelector('#modalIdentification');
      const modalConfidence = reviewModal.querySelector('#modalConfidence');
      const modalProcessingTime = reviewModal.querySelector('#modalProcessingTime');
      const modalDateTime = reviewModal.querySelector('#modalDateTime');

      modalImage.src = 'static/' + imagePath;
      modalIdentification.textContent = identification;

      modalConfidence.textContent = confidence;
      //   modalCorrection.textContent = isCorrect;
      //   modalIdentificationCorrection.textContent = newIdentification;
      modalProcessingTime.textContent = processingTime;
      modalDateTime.textContent = dateTime;

      const updateButton = document.getElementById('updateButton');
      updateButton.addEventListener('click', function () {
        // Membuat alert dengan SweetAlert2
        Swal.fire({
          title: 'Apakah Anda Yakin?',
          text: 'Update akan masuk ke data feedback',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Update',
          cancelButtonText: 'Cancel',
        }).then((result) => {
          if (result.isConfirmed) {
            // Jika tombol "Update" diklik
            const newIdentification = document.getElementById(
              'modalIdentificationCorrection'
            ).value;

            // Kirim data ke API (sesuaikan dengan endpoint dan data yang diperlukan)
            fetch('/update_identification', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                id: id,
                new_identification: newIdentification,
                image_path: imagePath,
              }),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`Error: ${response.status} - ${response.statusText}`);
                }
                return response.json();
              })
              .then((data) => {
                // Tampilkan pesan sukses atau lakukan tindakan lain setelah update berhasil
                Swal.fire('Updated!', 'Identifikasi berhasil diperbarui.', 'success');
                // kembali ke halaman utama
                window.location.href = '/';
              })
              .catch((error) => {
                console.error('Error updating identification:', error);
                // Tampilkan pesan error kepada pengguna
              });
          }
        });
      });
    });
    async function fetchReviewStatus() {
      const response = await fetch('/get_review_status');
      const data = await response.json();

      // Perbarui warna dan teks tombol berdasarkan status review
      data.forEach((item) => {
        const button = document.querySelector(`[data-bs-id="${item.id}"]`);
        if (button) {
          if (item.is_reviewed == 0) {
            button.classList.add('btn-primary'); // Biru jika belum direview
            button.textContent = 'Review';
          } else {
            button.classList.add('btn-success'); // Hijau jika sudah direview
            button.textContent = 'Reviewed';
          }
        }
      });
    }

    // Event listener untuk tombol "Review"
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('review-button')) {
        const button = event.target;
        const historyId = button.getAttribute('data-bs-id');

        fetch(`/update_review_status/${historyId}`, { method: 'POST' })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              button.classList.remove('btn-primary');
              button.classList.add('btn-success');
              button.textContent = 'Reviewed'; // Ubah teks tombol
            } else {
              console.error('Failed to update review status:', data.error);
            }
          })
          .catch((error) => {
            console.error('Error updating review status:', error);
          });
      }
    });

    // Panggil fungsi saat halaman dimuat
    fetchReviewStatus();
  </script>
</html>
